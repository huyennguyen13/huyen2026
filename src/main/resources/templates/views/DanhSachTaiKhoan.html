<!DOCTYPE html>
<html lang="vi">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Danh sách tài khoản</title>
<!-- ===== Boxicons CSS ===== -->
<link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css'
	rel='stylesheet'>
<!-- Linking Google Font Link For Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
	rel="stylesheet">
<link th:href="@{/css/style-admin.css}" rel="stylesheet" />
<link th:href="@{/css/style-km.css}" rel="stylesheet" />

<!-- Bootstrap CSS v5.2.1 -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
	crossorigin="anonymous" />
<!-- (Optional) Use CSS or JS implementation -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/js/all.min.js"
	integrity="sha512-naukR7I+Nk6gp7p5TMA4ycgfxaZBJ7MO5iC3Fp6ySQyKFHOGfpkSZkYVWV5R7u7cfAicxanwYQ5D1e17EfJcMA=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript"
	src="https://www.gstatic.com/charts/loader.js"></script>
<!-- Thư viện excel -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style type="text/css">
button.btn.btn-warning {
	padding: 3px 7px; /* Giảm padding để nút nhỏ hơn */
	font-size: 0.9rem; /* Giảm kích thước font chữ */
	display: flex;
	align-items: center;
	justify-content: center;
	margin-left: 30px;
}

button.btn.btn-warning i {
	margin-left: 5px; /* Đưa icon dấu cộng qua phải */
}

.status-column {
	text-align: left; /* Căn trái */
	padding-left: 10px; /* Cách lề trái */
}
</style>
</head>

<body>

	<nav th:replace="~{views/layout/header :: nav}"></nav>
	<aside th:replace="~{views/layout/aside :: aside}"></aside>
	<article class="container" style="padding-top: 6%; padding-bottom: 5%;">
		<!-- NOI DUNG O DAY -->
		<div class="box-work">
			<div class="title">
				<h1>
					<b>Danh Sách</b> <span class="edit_text-title">Tài Khoản</span>
				</h1>
				<h2
					style="display: flex; justify-content: flex-end; margin-top: -45px;">
					<a style="color: #f1642c;" th:href="@{/admin/quanlytaikhoan}">
						<i title="Thêm nhân viên" class="fa-solid fa-circle-plus"></i>
					</a>
				</h2>

				<div class="row mb-3">
					<div class="col-sm-3">
						<input type="text" id="searchInput" onkeyup="filterTable()"
							class="form-control" placeholder="Tìm kiếm họ và tên...">
					</div>
					<div class="col-sm-1">
						<button id="voiceSearchBtn" class="btn btn-dark">
							<i class="fa-solid fa-microphone"></i>
						</button>
					</div>
					<div class="col-sm-4">
						<!-- Lọc theo vai trò -->
						<select id="roleFilter" onchange="filterByCriteria()"
							class="form-select">
							<option value="Tất cả">Tất cả vai trò</option>
							<option value="Quản trị">Quản trị</option>
							<option value="Nhân viên">Nhân viên</option>
							<option value="Khách hàng">Khách hàng</option>
						</select>
					</div>
					<div class="col-sm-4">
						<!-- Lọc theo trạng thái -->
						<select id="statusFilter" onchange="filterByCriteria()"
							class="form-select">
							<option value="Tất cả">Tất cả trạng thái</option>
							<option value="Đang hoạt động">Đang hoạt động</option>
							<option value="Ngừng hoạt động">Ngừng hoạt động</option>
						</select>
					</div>
				</div>
			</div>
		</div>
		<div class="table text-center card p-2">
			<table class="table table-hover" id="myTable">
				<thead>
					<tr>
						<th scope="col">Họ và tên</th>
						<th scope="col">Email</th>
						<th scope="col">SDT</th>
						<th scope="col">Vai trò</th>
						<th scope="col" style="width: 165px;">Trạng thái</th>
						<th scope="col">Hành động</th>
					</tr>
				</thead>
				<tbody id="table-body">
					<tr th:each="tk : ${tks}">
						<td scope="row" th:text="${tk.hoTen}"></td>
						<td th:text="${tk.email}"></td>
						<td th:text="${tk.soDienThoai}"></td>
						<td th:switch="${tk.quyen.value}"><span th:case="0">Tất cả</span>
							<span th:case="1">Quản trị</span>
							<span th:case="2">Nhân viên</span> 
							<span th:case="3">Khách hàng</span></td>
						<!-- <td class="text-primary"
							th:text="${tk.trangThai ? 'Ngừng hoạt động' : 'Đang hoạt động'}"></td> -->
						<td class="status-column" th:id="'status-' + ${tk.taiKhoanId}">
							    <span th:text="${tk.trangThai != null ? (tk.trangThai ? 'Đang hoạt động' : 'Ngừng hoạt động') : 'Đang hoạt động'}"
          th:class="${tk.trangThai != null ? (tk.trangThai ? 'text-success' : 'text-warning') : 'text-success'}"></span>

							<!-- Chỉ hiển thị toggle cho nhân viên và khách hàng --> <i
							class="fa-solid fa-rotate float-end"
							th:if="${tk.quyen.value == 2 or tk.quyen.value == 3}"
							th:onclick="'toggleStatus(' + ${tk.taiKhoanId} + ')'"
							style="cursor: pointer; transform: translateY(4px);"></i>
						</td>


						<td>
							<form action="/admin/quanlytaikhoan/nhuongquyen" method="post">
								<input type="hidden" name="taiKhoanId"
									th:value="${tk.taiKhoanId}" />
								<button class="btn btn-warning" th:if="${tk.quyen.value==2}"
									type="submit"
									onclick="confirmNhuongQuyen(event, '${tk.taiKhoanId}')">
									Nhượng quyền</button>
							</form> <!-- <a th:href="@{/admin/quanlytaikhoan/xoa/{taiKhoanId}(taiKhoanId=${tk.taiKhoanId})}" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc muốn xóa không?')">Xóa</a> -->
						</td>
					</tr>
				</tbody>
			</table>
			<ul id="pagination" class="pagination justify-content-center"></ul>
			<!-- Modal Xác nhận -->
			<div class="modal fade" id="confirmModal" tabindex="-1"
				aria-labelledby="confirmModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="confirmModalLabel">Xác nhận hành
								động</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Close"></button>
						</div>
						<div class="modal-body">Bạn có chắc muốn thay đổi trạng thái
							tài khoản này?</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">Hủy</button>
							<button type="button" class="btn btn-danger" id="confirmButton">Xác
								nhận</button>
						</div>
					</div>
				</div>
			</div>

		</div>

		<!-- Nút xuất Excel -->
		<button onclick="confirmExport('myTable', 'Danh sách tài khoản')"
			class="float-end btn btn-outline-success tex fw-bold">
			<img class="pe-2" th:src="@{/img/admin/excel.png}" alt="Xuất Excel">Xuất
			Excel
		</button>
	</article>


	<script>
		// Hàm để hiển thị mật khẩu dạng ẩn với số lượng ký tự cố định (******)
		function maskPasswords() {
			var passwordCells = document.querySelectorAll("td[data-password]");
			passwordCells.forEach(function(cell) {
				cell.textContent = "******"; // Hiển thị mật khẩu dạng 6 ký tự ******
			});
		}

		// Gọi hàm để hiển thị mật khẩu dạng ****** khi trang được tải
		maskPasswords();

		function filterTable() {
			var input, filter, table, tr, td, i, txtValue;
			input = document.getElementById("searchInput");
			filter = input.value.toUpperCase();
			table = document.getElementById("myTable");
			tr = table.getElementsByTagName("tr");

			for (i = 1; i < tr.length; i++) {
				td = tr[i].getElementsByTagName("td")[0]; // Lọc theo cột tên
				if (td) {
					txtValue = td.textContent || td.innerText;
					if (txtValue.toUpperCase().indexOf(filter) > -1) {
						tr[i].style.display = "";
					} else {
						tr[i].style.display = "none";
					}
				}
			}
		}
	</script>
	<!-- Thông báo khi ấn nút nhượng quyền -->
	<script type="text/javascript">
		function confirmNhuongQuyen(event, taiKhoanId) {
			// Hiển thị thông báo xác nhận
			if (confirm("Sau khi nhượng quyền bạn sẽ mất quyền quản lý và đăng xuất khỏi đây, bạn có chắc muốn nhượng quyền?")) {
				// Nếu đồng ý, tiếp tục gửi form
				var form = document.getElementById('nhuongQuyenForm_'
						+ taiKhoanId);
				form.submit();
			} else {
				// Nếu không đồng ý, ngừng hành động
				event.preventDefault();
			}
		}
	</script>

	<script type="text/javascript">
    function toggleStatus(taiKhoanId) {
        // Hiển thị thông báo xác nhận
        const isConfirmed = confirm("Bạn có chắc muốn thay đổi trạng thái tài khoản này?");
        
        if (isConfirmed) {
            fetch(`/admin/quanlytaikhoan/updateStatus/${taiKhoanId}`, {
                method: 'POST',
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Không thể cập nhật trạng thái");
                }
                return response.json();
            })
            .then(data => {
                // Cập nhật trạng thái trong giao diện người dùng
                const statusCell = document.getElementById(`status-${taiKhoanId}`);
                const statusText = statusCell.querySelector('span');
                const newStatus = data.trangThai ? 'Đang hoạt động' : 'Ngừng hoạt động';

                // Cập nhật phần văn bản
                statusText.textContent = newStatus;

                // Cập nhật màu sắc văn bản
                if (data.trangThai) {
                    statusText.classList.add('text-success');
                    statusText.classList.remove('text-warning');
                } else {
                    statusText.classList.add('text-warning');
                    statusText.classList.remove('text-success');
                }

                // Cập nhật biểu tượng toggle
                const icon = statusCell.querySelector('i');
                if (data.trangThai) {
                    icon.classList.add('fa-toggle-on');
                    icon.classList.remove('fa-toggle-off');
                    icon.style.color = 'green'; // Biểu tượng đang hoạt động
                } else {
                    icon.classList.add('fa-toggle-off');
                    icon.classList.remove('fa-toggle-on');
                    icon.style.color = 'gray'; // Biểu tượng ngừng hoạt động
                }
            })
            .catch(error => {
                console.error('Có lỗi xảy ra:', error);
            });
        }
    }
</script>



	<!-- TÌM KIẾM BẰNG GIỌNG NÓI -->

	<script>
    // Kiểm tra trình duyệt hỗ trợ SpeechRecognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();

    // Cài đặt ngôn ngữ nhận diện giọng nói (tiếng Việt)
    recognition.lang = 'vi-VN';

    // Bắt đầu nhận diện khi bấm nút
    document.getElementById('voiceSearchBtn').addEventListener('click', function() {
        recognition.start();
    });

    recognition.onresult = function(event) {
        // Lấy kết quả từ giọng nói
        const voiceInput = event.results[0][0].transcript;
        document.getElementById('searchInput').value = voiceInput; // Hiển thị văn bản trong ô tìm kiếm
        filterTable(); // Gọi hàm lọc bảng
    };

    recognition.onerror = function(event) {
        console.error('Lỗi nhận diện giọng nói:', event.error);
    };
</script>

	<!-- Phân trang -->
	<script type="text/javascript">
//Pagination logic
const itemsPerPage = 5;
let currentPage = 1;

function displayItems() {
    const rows = document.querySelectorAll('#table-body tr');
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;

    rows.forEach((row, index) => {
        row.style.display = (index >= start && index < end) ? '' : 'none';
    });
}

function createPagination() {
    const rows = document.querySelectorAll('#table-body tr');
    const totalPages = Math.ceil(rows.length / itemsPerPage);
    const paginationContainer = document.getElementById('pagination');
    paginationContainer.innerHTML = ''; // Clear current pagination

    // Nút Previous
    const prevItem = document.createElement('li');
    prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevItem.innerHTML = `<a class="page-link" href="#" onclick="changePage('prev')"><<</a>`;
    paginationContainer.appendChild(prevItem);

    // Các nút trang
    for (let i = 1; i <= totalPages; i++) {
        const pageItem = document.createElement('li');
        pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageItem.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationContainer.appendChild(pageItem);
    }

    // Nút Next
    const nextItem = document.createElement('li');
    nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextItem.innerHTML = `<a class="page-link" href="#" onclick="changePage('next')">>></a>`;
    paginationContainer.appendChild(nextItem);
}

function changePage(page) {
    const rows = document.querySelectorAll('#table-body tr');
    const totalPages = Math.ceil(rows.length / itemsPerPage);

    if (page === 'prev' && currentPage > 1) {
        currentPage--;
    } else if (page === 'next' && currentPage < totalPages) {
        currentPage++;
    } else if (typeof page === 'number') {
        currentPage = page;
    }

    displayItems();
    createPagination();
}

// Khởi tạo khi tải trang
document.addEventListener('DOMContentLoaded', () => {
    displayItems();
    createPagination();
});
</script>
	<!--JavaScript Libraries -->
	<script th:src="@{/js/reload.js}"></script>
	<script th:src="@{/js/chart.js}"></script>
	<script th:src="@{/js/page.js}"></script>
	<script th:src="@{/js/app.js}"></script>
	<script th:src="@{/js/script-admin.js}"></script>
	<script th:src="@{/js/app.js}"></script>
	<!-- =================================== -->

	<!-- <script src="script.js"></script> -->
	<script
		src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
		integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
		crossorigin="anonymous"></script>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
		integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
		crossorigin="anonymous"></script>
</body>

</html>