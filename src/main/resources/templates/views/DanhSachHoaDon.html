<!DOCTYPE html>
<html lang="vi">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Danh sách hóa đơn</title>
<!-- ===== Boxicons CSS ===== -->
<link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css'
	rel='stylesheet'>
<!-- Linking Google Font Link For Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
	href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
	rel="stylesheet">
<link th:href="@{/css/style-admin.css}" rel="stylesheet" />

<!-- Bootstrap CSS v5.2.1 -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
	crossorigin="anonymous" />
<!-- (Optional) Use CSS or JS implementation -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/js/all.min.js"
	integrity="sha512-naukR7I+Nk6gp7p5TMA4ycgfxaZBJ7MO5iC3Fp6ySQyKFHOGfpkSZkYVWV5R7u7cfAicxanwYQ5D1e17EfJcMA=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript"
	src="https://www.gstatic.com/charts/loader.js"></script>
<!-- Thư viện excel -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>

	<nav th:replace="~{views/layout/header :: nav}"></nav>
	<aside th:replace="~{views/layout/aside :: aside}"></aside>
	<article class="container" style="padding-top: 6%; padding-bottom: 5%;">
		<!-- NOI DUNG O DAY -->
		<div class="box-work">
			<div class="title">
				<h1>
					<b>Danh Sách</b> <span class="edit_text-title">Hóa Đơn</span>
				</h1>
				<div class="mb-3">
					<div class="row g-2">
						<!-- Lọc theo tên khách hàng -->
						<div class="col">
							<input type="text" class="form-control" id="customerFilter"
								placeholder="Lọc theo tên khách hàng" onkeyup="filterTableHD()">
						</div>
						<!-- Lọc theo ngày -->
						<div class="col">
							<input type="date" class="form-control" id="dateFilter"
								onchange="filterTableHD()">
						</div>
						<!-- Lọc theo trạng thái -->
						<div class="col">
							<select class="form-select" id="statusFilter"
								onchange="filterTableHD()">
								<option value="">Trạng thái đơn</option>
								<option value="1">Chờ xác nhận</option>
								<option value="2">Đã xác nhận</option>
								<option value="3">Đang giao</option>
								<option value="4">Đã giao</option>
								<option value="5">Đã nhận</option>
								<option value="6">Đã hủy</option>
							</select>

						</div>
					</div>
				</div>
			</div>


			<div class="table text-center card p-2">
				<table class="table table-hover" id="orderTable">
					<thead class="table-light">
						<tr>
							<th>Mã hóa đơn</th>
							<th>Tên khách hàng</th>
							<th>Địa chỉ</th>
							<th>Tổng tiền</th>
							<th>Phương thức thanh toán</th>
							<th>Trạng thái</th>
							<th>Trạng thái đơn</th>
							<th>Ngày tạo</th>
							<th>Hành động</th>
						</tr>
					</thead>
					<tbody>
						<tr class="promo" th:each="hd : ${hds}">
							<td class="text-start text-center" th:text="${hd.hoaDonId}"><input
								type="hidden" name="hoaDonId" th:value="${hd.hoaDonId}" /></td>
							<td th:text="${hd.taiKhoans.hoTen}"></td>
							<td th:text="${hd.diaChi}"></td>
							<td th:text="${#numbers.formatCurrency(hd.tongTien)}"></td>
							<td th:text="${hd.trangThai ? 'Tiền mặt' : 'Trực tuyến'}"></td>
							<td
								th:text="${hd.trangThai ? 'Chưa thanh toán' : 'Đã thanh toán'}"></td>
							<td class="text-start"><select name="choXacNhan"
								style="border: none; background-color: transparent;"
								th:value="${hd.choXacNhan}"
								class="choXacNhanSelect w-100 text-center">
									<option th:each="entry : ${trangThaiMap}"
										th:value="${entry.key}" th:text="${entry.value}"
										th:selected="${hd.choXacNhan == entry.key}"></option>
							</select></td>
							<td th:text="${#dates.format(hd.ngayTao, 'yyyy-MM-dd')}"></td>
							<td><button type="button"
									class="btn btn-secondary updateBtn" th:data-id="${hd.hoaDonId}">Lưu</button></td>
						</tr>
					</tbody>
				</table>
			</div>
			<!-- Nút xuất Excel -->
			<button onclick="confirmExport('orderTable', 'Danh sách hóa đơn')"
				class="float-end btn btn-outline-success tex fw-bold">
				<img class="pe-2" th:src="@{/img/admin/excel.png}" alt="Xuất Excel" />Xuất
				Excel
			</button>
		</div>
	</article>
	<!-- Include jQuery -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
    // Đối tượng trạng thái đơn
    const trangThaiDon = {
        1: "Chờ xác nhận",
        2: "Đã xác nhận",
        3: "Đang giao",
        4: "Đã giao",
        5: "Đã nhận",
        6: "Đã hủy"
    };

    // Hàm lọc bảng theo tên khách hàng, ngày và trạng thái
    function filterTableHD() {
        // Lấy các giá trị lọc từ các input
        const customerFilter = document.getElementById('customerFilter').value.toLowerCase();
        const dateFilter = document.getElementById('dateFilter').value; // Ngày được nhập từ bộ lọc
        const statusFilter = document.getElementById('statusFilter').value; // Lọc theo trạng thái
        const rows = document.querySelectorAll('#orderTable tbody tr');

        rows.forEach(row => {
            const customerName = row.cells[1].textContent.toLowerCase(); // Tên khách hàng
            const createdDateRaw = row.cells[7].textContent.trim(); // Ngày tạo (cột ngày tạo)
            const statusCell = row.cells[6]; // Trạng thái đơn ở cột thứ 7 (index 6)
            const rowStatusValue = statusCell.querySelector('select').value; // Giá trị trạng thái trong select

            // Định dạng lại ngày từ bảng thành YYYY-MM-DD
            const createdDate = new Date(createdDateRaw);
            const formattedCreatedDate = !isNaN(createdDate)
                ? createdDate.toISOString().split('T')[0] // Chuyển thành YYYY-MM-DD
                : '';

            // Kiểm tra các điều kiện lọc
            const matchesCustomer = customerName.includes(customerFilter); // Lọc tên khách hàng
            const matchesDate = !dateFilter || formattedCreatedDate === dateFilter; // Lọc ngày
            const matchesStatus = !statusFilter || rowStatusValue == statusFilter; // Lọc trạng thái đơn

            // Hiển thị hàng nếu tất cả điều kiện thỏa mãn
            if (matchesCustomer && matchesDate && matchesStatus) {
                row.style.display = ''; // Hiển thị hàng
            } else {
                row.style.display = 'none'; // Ẩn hàng
            }
        });
    }
</script>


	<script>
		$(document)
				.ready(
						function() {
							// Khi nhấn nút "Lưu"
							$(".updateBtn")
									.click(
											function() {
												var hoaDonId = $(this).data(
														"id"); // Lấy ID hóa đơn từ data-id
												var choXacNhan = $(this)
														.closest("tr")
														.find(
																"select[name='choXacNhan']")
														.val(); // Lấy giá trị chọn từ select

												// Gửi yêu cầu AJAX
												$
														.ajax({
															url : '/employee/danhsach/danhsachhoadon/capnhat', // Đường dẫn đến controller
															type : 'POST',
															data : {
																hoaDonId : hoaDonId,
																choXacNhan : choXacNhan
															},
															success : function(
																	response) {
																alert("Cập nhật thành công!");
																// Có thể làm mới bảng hoặc làm gì đó khi thành công
															},
															error : function(
																	xhr,
																	status,
																	error) {
																alert("Đã có lỗi xảy ra: "
																		+ error);
															}
														});
											});
						});
	</script>

	<!--JavaScript Libraries -->
	<script th:src="@{/js/reload.js}"></script>
	<script th:src="@{/js/chart.js}"></script>
	<script th:src="@{/js/page.js}"></script>
	<script th:src="@{/js/app.js}"></script>
	<script th:src="@{/js/app.js}"></script>
	<!-- =================================== -->

	<!-- <script src="script.js"></script> -->
	<script
		src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
		integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
		crossorigin="anonymous"></script>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
		integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
		crossorigin="anonymous"></script>
</body>

</html>